{% extends "wow_skills_base.html" %}

{% load static_url %}
{% block local_css %}
{% endblock %}

{% block top_right %}
<button style="float: right;border:0;" onclick="location.href='/wow_skills/admin/'">참여</button>
{% endblock %} 

{% block content %}
<div id="search_tool_wrap" style="display:flex;height:40px;">
    <form action="{% url 'wow_skills:get_wow_skill_info' %}" name="get_wow_skill_info" id="form_get_wow_skill_info" method="get" style="display: flex;width:100%;">
        {% csrf_token %}
        <div style="flex:1 1 0;height:100%">
            <input type="text" name="skill_id" style="width:100%;height:100%;box-sizing: border-box;font-size:18px;font-weight:500" placeholder="검색어 입력">
        </div>
        <div style="flex-basis:110px;height:100%;text-align:right;">
            <button style="height:100%;" onclick="search(event);">검색</button>
            <button style="height:100%;" onclick="init(event)">초기화</button>
        </div>
    </form>
</div>

<div id="result_display_wrap" style="margin-top: 50px;">
    <div class="result_row">
        <!--<img src="https://wow.zamimg.com/images/wow/icons/large/spell_shadow_ritualofsacrifice.jpg" alt="" style="vertical-align: middle;">
        <span style="vertical-align: middle;">사악한 일격</span>-->
        <div>
            <img src="" id="skill_icon_img">
        </div>
        <div id="description_wrapper" style="display: inline-block;">
        </div>
        <div id="description_wrapper_img">
        </div>
    </div>
</div>
{% endblock %}

{% block local_js_footer %}
    <script>

    function init(e){
        e.preventDefault();
        e.stopPropagation();
        location.reload();
    }

    function search(e){
        e.stopPropagation();
        e.preventDefault();
        $.ajax({
            // url: '/wow_skills/get_wow_skill_info/',
            url: '/wow_skills/get_wow_skill_info_from_blizzard/',
            data: $('#form_get_wow_skill_info').serialize(),
            dataType: 'json',
            type: 'GET',

            beforeSend: function () {
                $('#skill_id').text('');
                $('#skill_name').text('');
                $('#skill_icon').text('');
                $('#skill_description').text('');
                $('#skill_cast_time').text('');
                $('#skill_power_cost').text('');
                $('#skill_range').text('');
                $('#skill_cool_down').text('');
                $('#skill_icon_img').attr('src', '');
            },

            success: function (data) {
                console.log(data);
                if(Object.keys(data).length == 0){
                    $('#skill_icon_img').attr('src', '');
                    alert('blizzard api에 없는 skill 입니다.');
                    return;
                }
                
                $('#skill_icon_img').attr('src', 'https://wow.zamimg.com/images/wow/icons/large/'+data.icon+'.jpg');
                let html = dom_description(data);
                $('#description_wrapper').html(html);

                setTimeout(()=>{
                    html2canvas(document.querySelector("#description_wrapper")).then(canvas => { 
                        
                        let image_src = canvas.toDataURL("image/jpeg");
                        document.querySelector('#description_wrapper_img').innerHTML = `<div>Image File</div><img src="${image_src}">`;
                    });  
                }, 1000);
            },

            complete: function () {
            },

            error: function () {
            }
        });
    }

    function dom_description(data){

        let skill_id = data.id;
        let skill_name = data.name;
        let skill_cost = data.powerCost;
        let skill_cast_time = data.castTime;
        let skill_classes = data.classes;
        let skill_specialize = data.specialize;
        let skill_cool_down = data.cooldown;
        let skill_range = data.range;
        let skill_description = data.description;

        let html = 
                    `
                    <div style="width:100%;max-width:300px;padding:10px;border-radius:5px;border:1px solid #f5f2f3;background-color:#161721d9;color:#ffffff;font-weight:500;font-size:14px;box-sizing:border-box">
                        <div>${skill_name}</div>
                        <div style="display:flex;margin-top:3px;">
                            ${skill_cost == undefined ? "" : '<div style="flex:1 1 0">'+skill_cost+'</div>'}
                            ${skill_range == undefined ? "" : '<div style="flex:1 1 0;text-align:right;">'+skill_range+'</div>'}
                        </div>
                        <div style="display:flex;margin-top:3px;">
                            ${skill_cast_time == undefined ? "" : '<div style="flex:1 1 0">'+skill_cast_time+'</div>'}
                            ${skill_cool_down == undefined ? "" : '<div style="flex:1 1 0;text-align:right;">'+skill_cool_down+'</div>'}
                        </div>
                        <div style="margin-top:10px;color:#edb31c;">
                            ${skill_description == undefined ? "" : skill_description}
                        </div>
                    </div>`;
        return html;
    }

    </script>
{% endblock %}