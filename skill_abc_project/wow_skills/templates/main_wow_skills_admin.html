{% extends "wow_skills_base.html" %}

{% load static_url %}
{% block local_css %}
{% endblock %}

{% block top_right %}
<button style="float: right;border:0;" onclick="location.href='/wow_skills/'">나가기</button>
{% endblock %}    

{% block content %}
<div id="search_tool_wrap" style="display:flex;height:40px;">
    <form action="{% url 'wow_skills:get_wow_skill_info_from_blizzard' %}" name="get_wow_skill_info" id="form_get_wow_skill_info" method="get" style="display: flex;width:100%;">
        {% csrf_token %}
        <div style="flex:1 1 0;height:100%">
            <input type="text" name="skill_id" style="width:100%;height:100%;box-sizing: border-box;font-size:18px;font-weight:500" placeholder="스킬 ID 입력">
        </div>
        <div style="flex-basis:110px;height:100%;text-align:right;">
            <button style="height:100%;" onclick="search_admin(event);">검색</button>
            <button style="height:100%;" onclick="init_admin(event);">초기화</button>
        </div>
    </form>
</div>

<div id="result_display_wrap" style="margin-top: 50px;">
    <div class="result_row">
        <form action="{% url 'wow_skills:add_wow_skill_info' %}" name="add_wow_skill_info" id="form_wow_skill_info" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="skill_info_row">
                <input type="hidden" name="wow_class_id" id="wow_class" >
                <input type="hidden" name="wow_specialize_id" id="wow_specialize" >
                <select onchange="fill_class_admin(this);" id="info_wow_class" style="">

                </select>
                <select onchange="fill_specialize_admin(this);" id="info_wow_specialize">

                </select>
            </div>
            <div class="skill_info_row">
                <div class="skill_info_title">아이콘</div>
                <div id="skill_icon_wrapper">
                    <input type="hidden" name="wow_skill_icon_img_small_url" id="wow_skill_icon_img_small_url" >
                    <input type="hidden" name="wow_skill_icon_img_medium_url" id="wow_skill_icon_img_medium_url" >
                    <input type="hidden" name="wow_skill_icon_img_large_url" id="wow_skill_icon_img_large_url" >
                    <img src="" name="wow_skill_icon_img_small" id="wow_skill_icon_img_small">
                    <img src="" name="wow_skill_icon_img_medium" id="wow_skill_icon_img_medium">
                    <img src="" name="wow_skill_icon_img_large" id="wow_skill_icon_img_large">
                </div>
            </div>
            <div class="skill_info_row">
                <div class="skill_info_title">스킬명</div>
                <div class="skill_info_content"><input type="text" name="wow_skill_name" id="wow_skill_name" disabled="true"></div>
            </div>
            <div class="skill_info_row">
                <div class="skill_info_title">설명</div>
                <div class="skill_info_content"><textarea type="text" name="wow_skill_description" id="wow_skill_description" disabled="true"></textarea></div>
            </div>
            <div class="skill_info_row">
                <div class="skill_info_title">ID</div>
                <div class="skill_info_content"><input type="text" name="wow_skill_id" id="wow_skill_id" disabled="true"></div>
            </div>
            <div class="skill_info_row">
                <div class="skill_info_title">아이콘</div>
                <div class="skill_info_content"><input type="text" name="wow_skill_icon" id="wow_skill_icon" disabled="true"></div>
            </div>
            <div class="skill_info_row">
                <div class="skill_info_title">시전시간</div>
                <div class="skill_info_content"><input type="text" name="wow_skill_cast_time" id="wow_skill_cast_time" disabled="true"></div>
            </div>
            <div class="skill_info_row">
                <div class="skill_info_title">마나/기력/분노..</div>
                <div class="skill_info_content"><input type="text" name="wow_skill_power_cost" id="wow_skill_power_cost" disabled="true"></div>
            </div>
            <div class="skill_info_row">
                <div class="skill_info_title">사정거리</div>
                <div class="skill_info_content"><input type="text" name="wow_skill_range" id="wow_skill_range" disabled="true"></div>
            </div>
            <div class="skill_info_row">
                <div class="skill_info_title">쿨다운</div>
                <div class="skill_info_content"><input type="text" name="wow_skill_cool_down" id="wow_skill_cool_down" disabled="true"></div>
            </div>
            <button id="add_wow_skill_form_submit" onclick="add_wow_skill(event);">등록</button>
        </form>
    </div>
</div>
{% endblock %}

{% block local_js_footer %}
    <script>
    var wow_class_specialize_tree = {};

    window.addEventListener('load', function () {
        // automation(); 데이터 미리 For문으로 넣기
        $.ajax({
            url:'/wow_skills/get_wow_class_specialize_data/',
            type:'GET',
            dataType : 'json',

            beforeSend:function(){
                //beforeSend();
            },

            //통신성공시 처리
            success:function(data){
                wow_class_specialize_tree = data;
                let classes = ['<option value="none" disabled selected>클래스 선택</option>'];
                for(let item in wow_class_specialize_tree){
                    classes.push(
                            `<option value="${item}">${wow_class_specialize_tree[item]['wow_class_name']}</div>`
                        );
                }
                $('#info_wow_class').html(classes.join(""));

            },

            //보내기후 팝업창 닫기
            complete:function(){
            },

            //통신 실패시 처리
            error:function(){
            }
        });
    });
    function init_admin(e){
        e.preventDefault();
        e.stopPropagation();
        location.reload();
    }

    function search_admin(e){
        if(e != undefined){
           e.stopPropagation();
            e.preventDefault(); 
        }
        
        $.ajax({
            url: '/wow_skills/get_wow_skill_info_from_blizzard/',
            data: $('#form_get_wow_skill_info').serialize(),
            dataType: 'json',
            type: 'GET',

            beforeSend: function () {
                loading_image('ON');
                $('#wow_skill_id').val('');
                $('#wow_skill_name').val('');
                $('#wow_skill_icon').val('');
                $('#wow_skill_description').val('');
                $('#wow_skill_cast_time').val('');
                $('#wow_skill_power_cost').val('');
                $('#wow_skill_range').val('');
                $('#wow_skill_cool_down').val('');
                $('#wow_skill_icon_img').attr('src', '');
            },

            success: function (data) {
                if(Object.keys(data).length == 0){
                    $('#skill_icon_img').attr('src', '');
                    alert('blizzard api에 없는 skill 입니다.');
                    return;
                }
                $('input, textarea').attr("disabled", false);
                $('#wow_skill_id').val(data.id);
                $('#wow_skill_name').val(data.name);
                $('#wow_skill_icon').val(data.icon);
                $('#wow_skill_description').val(data.description);
                $('#wow_skill_cast_time').val(data.castTime);
                $('#wow_skill_power_cost').val(data.powerCost);
                $('#wow_skill_range').val(data.range);
                $('#wow_skill_cool_down').val(data.cooldown);
                $('#wow_skill_icon_img_small').attr({'src': 'https://wow.zamimg.com/images/wow/icons/small/'+data.icon+'.jpg', "title":data.id});
                $('#wow_skill_icon_img_medium').attr({'src': 'https://wow.zamimg.com/images/wow/icons/medium/'+data.icon+'.jpg', "title":data.id});
                $('#wow_skill_icon_img_large').attr({'src': 'https://wow.zamimg.com/images/wow/icons/large/'+data.icon+'.jpg', "title":data.id});
                $('#wow_skill_icon_img_small_url').val('https://wow.zamimg.com/images/wow/icons/small/'+data.icon+'.jpg');
                $('#wow_skill_icon_img_medium_url').val('https://wow.zamimg.com/images/wow/icons/medium/'+data.icon+'.jpg');
                $('#wow_skill_icon_img_large_url').val('https://wow.zamimg.com/images/wow/icons/large/'+data.icon+'.jpg');
            },

            complete: function () {
                loading_image('OFF');
            },

            error: function () {
            }
        });
    }

    function add_wow_skill(e){
        if(e != undefined){
            e.stopPropagation();
            e.preventDefault();
        }
        
        $('#wow_skill_description').val( $('#wow_skill_description').val().replace(/\n/gi, "<br>") );
        $.ajax({
            url: '/wow_skills/add_wow_skill_info/',
            data: $('#form_wow_skill_info').serialize(),
            dataType: 'json',
            type: 'post',

            beforeSend: function () {
                loading_image('ON');
                // $('input, textarea').attr("disabled", true);
            },

            success: function (data) {
                // location.href = '/wow_skills/';
            },

            complete: function () {
                loading_image('OFF');
            },

            error: function () {
                // alert("에러 발생");
                console.log("에러 발생");
            }
        });
    }

    function fill_class_admin(context){
        let selected_class = $(context).val();
        let specializes = ['<option value="none" disabled selected>전문화 선택</option>'];
        for(let i=0; i<wow_class_specialize_tree[selected_class]['wow_specialize_type_id'].length; i++){
            specializes.push(
                `<option value="${wow_class_specialize_tree[selected_class]['wow_specialize_type_id'][i]}">${wow_class_specialize_tree[selected_class]['wow_specialize_type_name'][i]}</div>`
            );
        }
        $('#info_wow_specialize').html(specializes.join(""));
        $('#wow_class').val(selected_class);
    }

    function fill_specialize_admin(context){
        let selected_specialize = $(context).val();
        $('#wow_specialize').val(selected_specialize);
    }


    function automation(){

        let $search_input = $('#form_get_wow_skill_info input');

        let length = parsed_summary["skills"].length;
        for(let i=0; i<2; i++){
            (function(z){
                setTimeout(()=>{
                    let datas = parsed_summary["skills"][i];
                    let skill_id = datas["id"];
                    $search_input.val(skill_id);
                    search_admin();
                    setTimeout(()=>{
                        add_wow_skill();
                    }, 1500);
                    
                    console.log(i);
                    console.log(z, datas);
                }, 2500*z);
            })(i);
            
        }
    }
    
    </script>
{% endblock %}